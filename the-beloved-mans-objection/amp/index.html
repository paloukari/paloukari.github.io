<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">

    <title>The beloved man&#x27;s objection</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://havedatawilltrain.com/the-beloved-mans-objection/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="HAVE DATA - WILL TRAIN" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="The beloved man&#x27;s objection" />
    <meta property="og:description" content="This is the tenth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of Unit Testing in Azure IoT Edge." />
    <meta property="og:url" content="https://havedatawilltrain.com/the-beloved-mans-objection/" />
    <meta property="og:image" content="https://havedatawilltrain.com/content/images/2020/04/invertebrate.jpg" />
    <meta property="article:published_time" content="2020-04-28T23:31:01.000Z" />
    <meta property="article:modified_time" content="2020-04-29T03:02:51.000Z" />
    <meta property="article:tag" content="Azure IoT Edge" />
    
    <meta property="article:publisher" content="https://www.facebook.com/spyros.garyfallos" />
    <meta property="article:author" content="https://www.facebook.com/spyros.garyfallos" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The beloved man&#x27;s objection" />
    <meta name="twitter:description" content="This is the tenth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of Unit Testing in Azure IoT Edge." />
    <meta name="twitter:url" content="https://havedatawilltrain.com/the-beloved-mans-objection/" />
    <meta name="twitter:image" content="https://havedatawilltrain.com/content/images/2020/04/invertebrate.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Spyros Garyfallos" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Azure IoT Edge" />
    <meta name="twitter:site" content="@SpyrosCarnation" />
    <meta name="twitter:creator" content="@SpyrosCarnation" />
    <meta property="og:image:width" content="630" />
    <meta property="og:image:height" content="420" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "HAVE DATA - WILL TRAIN",
        "url": "https://havedatawilltrain.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://havedatawilltrain.com/content/images/2019/07/Logo2.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Spyros Garyfallos",
        "image": {
            "@type": "ImageObject",
            "url": "https://havedatawilltrain.com/content/images/2019/09/Capture.PNG",
            "width": 375,
            "height": 439
        },
        "url": "https://havedatawilltrain.com/author/spyros/",
        "sameAs": [
            "https://www.facebook.com/spyros.garyfallos",
            "https://twitter.com/SpyrosCarnation"
        ]
    },
    "headline": "The beloved man&#x27;s objection",
    "url": "https://havedatawilltrain.com/the-beloved-mans-objection/",
    "datePublished": "2020-04-28T23:31:01.000Z",
    "dateModified": "2020-04-29T03:02:51.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://havedatawilltrain.com/content/images/2020/04/invertebrate.jpg",
        "width": 630,
        "height": 420
    },
    "keywords": "Azure IoT Edge",
    "description": "This is the tenth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of Unit Testing in Azure IoT Edge.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://havedatawilltrain.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.12" />
    <link rel="alternate" type="application/rss+xml" title="HAVE DATA - WILL TRAIN" href="https://havedatawilltrain.com/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://havedatawilltrain.com">HAVE DATA - WILL TRAIN</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">The beloved man&#x27;s objection</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/spyros/">Spyros Garyfallos</a></p>
                    <time class="post-date" datetime="2020-04-28">2020-04-28</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://havedatawilltrain.com/content/images/2020/04/invertebrate.jpg" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>In this mini-series we have analyzed different challenges around IoT Edge development, and explored a few best practices that will help us avoid any unnecessary roughness when developing Edge applications. In the last post we saw how we can use most of these best practices to compose a loosely coupled Azure IoT Edge application and some tooling that allows us to have a true F5 development experience. Today we will see the main driver for all these patterns, which is <strong>unit testing</strong>.</p><p>The main challenge with any modern application is finding ways to test most of it's code, and then automating that. This automated testing capability can be perceived as the holy grail of every production system, because it greatly accelerates the <strong>software development life cycle </strong>iterations and eventually increases the overall product quality.</p><p>The challenge with Azure IoT Edge development is that the security and communication protocols are tightly coupled to the IoT C# SDK, making it very difficult to run a test without the corresponding infrastructure. Nevertheless, as we saw in <a href="https://havedatawilltrain.com/the-man-who-wouldnt-test/">this post</a>, there is an easy way to abstract this SDK dependency and run the business code using a <strong>mock implementation </strong>of the SDK. We will use the same approach to mock all other dependencies, and eventually test a stand alone business method, a <strong>unit</strong> <strong>test.</strong></p><h3 id="unit-testing-setup">Unit Testing Setup</h3><p>We will be using the <strong>xunit </strong>unit testing framework, a very popular option in .NET Core. We will build two projects from scratch, one <strong>IoT Edge module project </strong>similar to <a href="https://github.com/paloukari/SimulatedTemperatureSensor">this</a> template, and an <strong>xunit unit testing project </strong>that references the former.</p><ol><li>Create the solution and project folders</li></ol><pre><code class="language-bash">mkdir UnitTestingExample
cd UnitTestingExample

mkdir IoTModule
mkdir IoTModuleTests</code></pre><p>2. Create the IoT Edge Module project and add the required nugets </p><pre><code class="language-bash">cd IoTModule
dotnet new console
dotnet add package Microsoft.Azure.Devices.Client
dotnet add package Microsoft.Extensions.Hosting
dotnet add package Serilog.Extensions.Hosting
dotnet add package Serilog.Settings.Configuration
dotnet add package Serilog.Sinks.Console
dotnet add package Serilog.Enrichers.Thread</code></pre><p>4. Add the module code. We will replace the Program.cs code with:</p><pre><code class="language-c#">namespace IoTModule
{
    using System.Threading.Tasks;
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Hosting;
    using Serilog;

    class Program
    {
        static async Task Main(string[] args)
        {
            using (var host = Host.CreateDefaultBuilder(args)
                 .ConfigureServices((hostContext, services) =&gt;
                 {
                    services.AddSingleton&lt;IModuleClient, ModuleClientWrapper&gt;();
                    services.AddHostedService&lt;EventHandlerModule&gt;();
                 })
                 .UseSerilog()
                 .UseConsoleLifetime()
                 .Build())
            {
                await host.RunAsync();
            }
        }
    }
}
</code></pre><p>5. This code references the <code>IModuleClient</code>  the <code>ModuleClientWrapper</code> and the module class, the <code>EventHandlerModule</code>. We have seen before the first two before. They are useful to create an abstraction layer over the SDK and can be found in <a href="https://havedatawilltrain.com/genesis/">this</a> post. </p><p>6. The <code>EventHandlerModule.cs</code> code is this:</p><pre><code class="language-C#">namespace IoTModule
{
    using Microsoft.Azure.Devices.Client;
    using Microsoft.Extensions.Hosting;
    using Microsoft.Extensions.Logging;
    using System.Text;
    using System.Threading;
    using System.Threading.Tasks;

    public class EventHandlerModule : IHostedService
    {
        readonly IModuleClient moduleClient;
        readonly ILogger logger;

        public EventHandlerModule(IModuleClient moduleClient,
            ILogger&lt;EventHandlerModule&gt; logger)
        {
            this.moduleClient = moduleClient;
            this.logger = logger;
        }

        public async Task StartAsync(CancellationToken cancellationToken)
        {
            await moduleClient.OpenAsync(cancellationToken);

            await moduleClient.SetInputMessageHandlerAsync("input",
                new MessageHandler(async (message, context) =&gt;
                {
                    var messageText = Encoding.UTF8.GetString(message.GetBytes());
                    logger.LogInformation($"Message received: {messageText}");
                    return await Task.FromResult(MessageResponse.Completed);
                }), this);

            logger.LogInformation("Started.");
        }

        public async Task StopAsync(CancellationToken cancellationToken)
        {
            await moduleClient.CloseAsync(cancellationToken);
            logger.LogInformation("Stopped.");
        }
    }
}</code></pre><p>This module is fairly simple, it just expects messages in the input called <code>input</code> and logs the message content as string. When we try to run this application, we get an exception from the IoT SDK complaining about missing environment variable, required to connect to the edge daemon:</p><p><code>Environment variable IOTEDGE_WORKLOADURI is required.</code></p><p>It is clear that to test this message handler callback, we need to mock out the SDK.</p><h3 id="unit-test-project">Unit test project</h3><p>Let's setup our unit testing project now. We'll add the <code>Moq</code> nuget too:</p><pre><code class="language-bash">cd ..
cd IoTModuleTests
dotnet new xunit
dotnet add package Moq
dotnet add reference ..\IoTModule</code></pre><p>Let's replace the default test code with this empty test:</p><pre><code class="language-C#">namespace ModuleTests
{
    using Microsoft.Extensions.DependencyInjection;
    using Microsoft.Extensions.Hosting;
    using Xunit;
    using SimulatedTemperatureSensor;
    using Moq;
    using System.Threading;
    using Microsoft.Extensions.Logging;
    using Microsoft.Azure.Devices.Client;
    using System.Text;
    using System.Collections.Generic;
    using System.Threading.Tasks;

    public class EventHandlerModuleTester
    {
        [Fact]
        public async Task TestInputMessageHandler()
        {
            Assert.True(true);
        }
    }
}</code></pre><blockquote>This is a good moment to verify your code, you should be able to run this test successfully. Simply run <code>dotnet test</code></blockquote><p> This will be our first unit test that sends a message to the <code>input</code> input and expects a successful execution of the callback.  	</p><h3 id="mocking-the-iot-sdk">Mocking the IoT SDK</h3><p>Our test needs to setup a similar dependency injection mechanism and add in this mechanism all involved services, except for the <code>ModuleClientWrapper</code> which we will be mocking.</p><p>The test with <strong>just the dependency injection mechanism </strong>becomes:</p><pre><code class="language-C#">[Fact]
public void TestInputMessageHandler()
{
    var services = new ServiceCollection();

    services.AddHostedService&lt;EventHandlerModule&gt;();

    var serviceProvider = services.BuildServiceProvider();
    var hostedService = serviceProvider.GetService&lt;IHostedService&gt;();
    hostedService.StartAsync(new CancellationToken());
}</code></pre><p>This code will try to create and start our module, the <code>EventHandlerModule</code> hosted service class. Looking at this class constructor we can see that this service depends on two other services, the <code>IModuleClient</code> and the <code>ILogger&lt;EventHandlerModule&gt;</code> services.</p><p>Lets add a mock version of them:</p><pre><code class="language-C#">[Fact]
public async Task TestInputMessageHandler()
{
    var services = new ServiceCollection();

    services.AddHostedService&lt;EventHandlerModule&gt;();
    services.AddSingleton((s) =&gt;
    {
        var moduleClient = new Mock&lt;IModuleClient&gt;();
        return moduleClient.Object;
    });

    services.AddSingleton((s) =&gt;
    {
        var mockLogger = new Mock&lt;ILogger&lt;EventHandlerModule&gt;&gt;();
        return mockLogger.Object;
    });

    var serviceProvider = services.BuildServiceProvider();

    var hostedService = serviceProvider.GetService&lt;IHostedService&gt;();
    await hostedService.StartAsync(new CancellationToken());
}</code></pre><p>Now this test is complete, in terms having a valid dependency hierarchy in place. In fact, running this test will yield a successful result. We are still missing two last tasks, to inject a message to the module's input and validate a successful callback execution. In other words, we will override the <code>IModuleClient</code>'s  <code>SendEventAsync</code>  and <code>SetInputMessageHandlerAsync</code> methods to send a message to the registered callback. To do this, we will use a <code>Dictionary&lt;string, (MessageHandler, object)&gt;</code> structure to keep the callback in memory and invoke it when we get a message:</p><pre><code class="language-C#">[Fact]
public void _TestInputMessageHandler()
{
    var inputMessageHandlers = new Dictionary&lt;string, (MessageHandler, object)&gt;();

    var services = new ServiceCollection();

    services.AddHostedService&lt;EventHandlerModule&gt;();
    services.AddSingleton((s) =&gt;
    {
        var moduleClient = new Mock&lt;IModuleClient&gt;();

        moduleClient.Setup(e =&gt; e.SetInputMessageHandlerAsync(
            It.IsAny&lt;string&gt;(),
            It.IsAny&lt;MessageHandler&gt;(),
            It.IsAny&lt;object&gt;()))
        .Callback&lt;string, MessageHandler, object&gt;((inputName, messageHandler, userContext) =&gt;
        {
            inputMessageHandlers[inputName] = (messageHandler, userContext);
        }).Returns(Task.FromResult(0));

        moduleClient.Setup(e =&gt; e.SendEventAsync(
            It.IsAny&lt;string&gt;(),
            It.IsAny&lt;Message&gt;()))
        .Callback&lt;string, Message&gt;((output, message) =&gt;
        {
            var result = inputMessageHandlers[output].Item1(message,
                        inputMessageHandlers[output].Item2).GetAwaiter().GetResult();

            Assert.Equal(MessageResponse.Completed, result);

        }).Returns(Task.FromResult(0));

        return moduleClient.Object;
    });

    services.AddSingleton((s) =&gt;
    {
        var mockLogger = new Mock&lt;ILogger&lt;EventHandlerModule&gt;&gt;();
        return mockLogger.Object;
    });

    var serviceProvider = services.BuildServiceProvider();

    var hostedService = serviceProvider.GetService&lt;IHostedService&gt;();
    hostedService.StartAsync(new CancellationToken()).GetAwaiter().GetResult();

    serviceProvider.GetService&lt;IModuleClient&gt;()
        .SendEventAsync("input",
            new Message(Encoding.UTF8.GetBytes("This is a mocked message!"))).GetAwaiter().GetResult();
} </code></pre><p>By calling the <code>Assert.Equal(MessageResponse.Completed, result);</code> inside the <code>SendEventAsync</code> mock , our unit test validates that the callback executed successfully.</p><p>Although this test initially might seem too complicated for such a simple callback, most of this code is common to any other unit test we might implement, and it can be hidden in a dependency initialization step, shared across all other tests for the same module. Indeed, this common initialization step could be moved in this <code>Init</code> method:</p><pre><code class="language-C#">public async Task&lt;ServiceProvider&gt; Init(Action&lt;MessageResponse&gt; messageResultCallback)
{
    var inputMessageHandlers = new Dictionary&lt;string, (MessageHandler, object)&gt;();

    var services = new ServiceCollection();

    services.AddHostedService&lt;EventHandlerModule&gt;();
    services.AddSingleton((s) =&gt;
    {
        var moduleClient = new Mock&lt;IModuleClient&gt;();

        moduleClient.Setup(e =&gt; e.SetInputMessageHandlerAsync(
            It.IsAny&lt;string&gt;(),
            It.IsAny&lt;MessageHandler&gt;(),
            It.IsAny&lt;object&gt;()))
        .Callback&lt;string, MessageHandler, object&gt;((inputName, messageHandler, userContext) =&gt;
        {
            inputMessageHandlers[inputName] = (messageHandler, userContext);
        }).Returns(Task.FromResult(0));

        moduleClient.Setup(e =&gt; e.SendEventAsync(
            It.IsAny&lt;string&gt;(),
            It.IsAny&lt;Message&gt;()))
        .Callback&lt;string, Message&gt;((output, message) =&gt;
        {
            var result = inputMessageHandlers[output].Item1(message,
                        inputMessageHandlers[output].Item2).GetAwaiter().GetResult();

            messageResultCallback(result);

        }).Returns(Task.FromResult(0));

        return moduleClient.Object;
    });

    services.AddSingleton((s) =&gt;
    {
        var mockLogger = new Mock&lt;ILogger&lt;EventHandlerModule&gt;&gt;();
        return mockLogger.Object;
    });

    var serviceProvider = services.BuildServiceProvider();

    var hostedService = serviceProvider.GetService&lt;IHostedService&gt;();
    await hostedService.StartAsync(new CancellationToken());
    return serviceProvider;
}</code></pre><p>and in this case, our message handler unit test code becomes:</p><pre><code class="language-C#">[Fact]
public async Task TestInputMessageHandler()
{
    var serviceProvider = await Init((e) =&gt;
        Assert.Equal(MessageResponse.Completed, e));

    await serviceProvider.GetService&lt;IModuleClient&gt;()
        .SendEventAsync("input",
            new Message(Encoding.UTF8.GetBytes("This is a mocked message!")));
}</code></pre><blockquote>The code of this example has been published <a href="https://github.com/paloukari/AzureIoTEdgeUnitTesting">here</a>.</blockquote><h3 id="recap">Recap</h3><p>We saw how we can use the default .NET Core unit testing frameworks to <strong>build unit tests for our IoT Edge application</strong>. Following this approach we can define any other type of IoT Edge unit test, like twin update, direct method calls etc.  </p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://havedatawilltrain.com">HAVE DATA - WILL TRAIN</a> &copy; 2020</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
