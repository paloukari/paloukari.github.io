<!DOCTYPE html>
<html ⚡>
<head>
    <meta charset="utf-8">

    <title>The Service Room</title>

    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">

    <link rel="shortcut icon" href="/favicon.png" type="image/png" />
    <link rel="canonical" href="https://havedatawilltrain.com/the-service-room/" />
    <meta name="referrer" content="no-referrer-when-downgrade" />
    
    <meta property="og:site_name" content="HAVE DATA - WILL TRAIN" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="The Service Room" />
    <meta property="og:description" content="This is the fourth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of the application configuration." />
    <meta property="og:url" content="https://havedatawilltrain.com/the-service-room/" />
    <meta property="og:image" content="https://havedatawilltrain.com/content/images/2020/04/willys-jeep-dashboard-marco-oliveira.jpg" />
    <meta property="article:published_time" content="2020-04-10T18:38:20.000Z" />
    <meta property="article:modified_time" content="2020-04-10T20:43:41.000Z" />
    <meta property="article:tag" content="Azure IoT Edge" />
    
    <meta property="article:publisher" content="https://www.facebook.com/spyros.garyfallos" />
    <meta property="article:author" content="https://www.facebook.com/spyros.garyfallos" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="The Service Room" />
    <meta name="twitter:description" content="This is the fourth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of the application configuration." />
    <meta name="twitter:url" content="https://havedatawilltrain.com/the-service-room/" />
    <meta name="twitter:image" content="https://havedatawilltrain.com/content/images/2020/04/willys-jeep-dashboard-marco-oliveira.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Spyros Garyfallos" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Azure IoT Edge" />
    <meta name="twitter:site" content="@SpyrosCarnation" />
    <meta name="twitter:creator" content="@SpyrosCarnation" />
    <meta property="og:image:width" content="967" />
    <meta property="og:image:height" content="500" />
    
    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "HAVE DATA - WILL TRAIN",
        "url": "https://havedatawilltrain.com/",
        "logo": {
            "@type": "ImageObject",
            "url": "https://havedatawilltrain.com/content/images/2019/07/Logo2.png"
        }
    },
    "author": {
        "@type": "Person",
        "name": "Spyros Garyfallos",
        "image": {
            "@type": "ImageObject",
            "url": "https://havedatawilltrain.com/content/images/2019/09/Capture.PNG",
            "width": 375,
            "height": 439
        },
        "url": "https://havedatawilltrain.com/author/spyros/",
        "sameAs": [
            "https://www.facebook.com/spyros.garyfallos",
            "https://twitter.com/SpyrosCarnation"
        ]
    },
    "headline": "The Service Room",
    "url": "https://havedatawilltrain.com/the-service-room/",
    "datePublished": "2020-04-10T18:38:20.000Z",
    "dateModified": "2020-04-10T20:43:41.000Z",
    "image": {
        "@type": "ImageObject",
        "url": "https://havedatawilltrain.com/content/images/2020/04/willys-jeep-dashboard-marco-oliveira.jpg",
        "width": 967,
        "height": 500
    },
    "keywords": "Azure IoT Edge",
    "description": "This is the fourth post of a mini-series that aims to address the development experience and production readiness challenges in the space of IoT Edge, primarily under the lens of Azure IoT Edge. This post deals with the topic of the application configuration.",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://havedatawilltrain.com/"
    }
}
    </script>

    <meta name="generator" content="Ghost 3.12" />
    <link rel="alternate" type="application/rss+xml" title="HAVE DATA - WILL TRAIN" href="https://havedatawilltrain.com/rss/" />

    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,600,400" />
    <style amp-custom>html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block;vertical-align:baseline}audio:not([controls]){display:none;height:0}[hidden],template{display:none}a{background-color:transparent}a:active,a:hover{outline:0}abbr[title]{border-bottom:1px dotted}b,strong{font-weight:bold}dfn{font-style:italic}h1{margin:0.67em 0;font-size:2em}mark{background:#ff0;color:#000}small{font-size:80%}sub,sup{position:relative;vertical-align:baseline;font-size:75%;line-height:0}sup{top:-0.5em}sub{bottom:-0.25em}img{border:0}amp-img{border:0}svg:not(:root){overflow:hidden}figure{margin:1em 40px}hr{box-sizing:content-box;height:0}pre{overflow:auto}code,kbd,pre,samp{font-family:monospace, monospace;font-size:1em}button,input,optgroup,select,textarea{margin:0;color:inherit;font:inherit}button{overflow:visible}button,select{text-transform:none}button,html input[type="button"],input[type="reset"],input[type="submit"]{cursor:pointer;-webkit-appearance:button}button[disabled],html input[disabled]{cursor:default}button::-moz-focus-inner,input::-moz-focus-inner{padding:0;border:0}input{line-height:normal}input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}input[type="number"]::-webkit-inner-spin-button,input[type="number"]::-webkit-outer-spin-button{height:auto}input[type="search"]{-webkit-appearance:textfield}input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}fieldset{margin:0 2px;padding:0.35em 0.625em 0.75em;border:1px solid #c0c0c0}legend{padding:0;border:0}textarea{overflow:auto}optgroup{font-weight:bold}table{border-spacing:0;border-collapse:collapse}td,th{padding:0}html{max-height:100%;height:100%;font-size:62.5%;-webkit-tap-highlight-color:rgba(0, 0, 0, 0)}body{max-height:100%;height:100%;color:#3a4145;background:#f4f8fb;letter-spacing:0.01rem;font-family:"Merriweather", serif;font-size:1.8rem;line-height:1.75em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"kern" 1;-moz-font-feature-settings:"kern" 1;-o-font-feature-settings:"kern" 1}::-moz-selection{background:#d6edff}::selection{background:#d6edff}h1,h2,h3,h4,h5,h6{margin:0 0 0.3em 0;color:#2e2e2e;font-family:"Open Sans", sans-serif;line-height:1.15em;text-rendering:geometricPrecision;-webkit-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-moz-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1;-o-font-feature-settings:"dlig" 1, "liga" 1, "lnum" 1, "kern" 1}h1{text-indent:-2px;letter-spacing:-1px;font-size:2.6rem}h2{letter-spacing:0;font-size:2.4rem}h3{letter-spacing:-0.6px;font-size:2.1rem}h4{font-size:1.9rem}h5{font-size:1.8rem}h6{font-size:1.8rem}a{color:#4a4a4a}a:hover{color:#111}p,ul,ol,dl{margin:0 0 2.5rem 0;font-size:1.5rem;text-rendering:geometricPrecision;-webkit-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-moz-font-feature-settings:"liga" 1, "onum" 1, "kern" 1;-o-font-feature-settings:"liga" 1, "onum" 1, "kern" 1}ol,ul{padding-left:2em}ol ol,ul ul,ul ol,ol ul{margin:0 0 0.4em 0;padding-left:2em}dl dt{float:left;clear:left;overflow:hidden;margin-bottom:1em;width:180px;text-align:right;text-overflow:ellipsis;white-space:nowrap;font-weight:700}dl dd{margin-bottom:1em;margin-left:200px}li{margin:0.4em 0}li li{margin:0}hr{display:block;margin:1.75em 0;padding:0;height:1px;border:0;border-top:#efefef 1px solid}blockquote{box-sizing:border-box;margin:1.75em 0 1.75em 0;padding:0 0 0 1.75em;border-left:#4a4a4a 0.4em solid;-moz-box-sizing:border-box}blockquote p{margin:0.8em 0;font-style:italic}blockquote small{display:inline-block;margin:0.8em 0 0.8em 1.5em;color:#ccc;font-size:0.9em}blockquote small:before{content:"\2014 \00A0"}blockquote cite{font-weight:700}blockquote cite a{font-weight:normal}mark{background-color:#fdffb6}code,tt{padding:1px 3px;border:#e3edf3 1px solid;background:#f7fafb;border-radius:2px;white-space:pre-wrap;font-family:Inconsolata, monospace, sans-serif;font-size:0.85em;font-feature-settings:"liga" 0;-webkit-font-feature-settings:"liga" 0;-moz-font-feature-settings:"liga" 0}pre{overflow:auto;box-sizing:border-box;margin:0 0 1.75em 0;padding:10px;width:100%;border:#e3edf3 1px solid;background:#f7fafb;border-radius:3px;white-space:pre;font-family:Inconsolata, monospace, sans-serif;font-size:0.9em;-moz-box-sizing:border-box}pre code,pre tt{padding:0;border:none;background:transparent;white-space:pre-wrap;font-size:inherit}kbd{display:inline-block;margin-bottom:0.4em;padding:1px 8px;border:#ccc 1px solid;background:#f4f4f4;border-radius:4px;box-shadow:0 1px 0 rgba(0, 0, 0, 0.2), 0 1px 0 0 #fff inset;color:#666;text-shadow:#fff 0 1px 0;font-size:0.9em;font-weight:700}table{box-sizing:border-box;margin:1.75em 0;max-width:100%;width:100%;background-color:transparent;-moz-box-sizing:border-box}table th,table td{padding:8px;border-top:#efefef 1px solid;vertical-align:top;text-align:left;line-height:20px}table th{color:#000}table caption + thead tr:first-child th,table caption + thead tr:first-child td,table colgroup + thead tr:first-child th,table colgroup + thead tr:first-child td,table thead:first-child tr:first-child th,table thead:first-child tr:first-child td{border-top:0}table tbody + tbody{border-top:#efefef 2px solid}table table table{background-color:#fff}table tbody > tr:nth-child(odd) > td,table tbody > tr:nth-child(odd) > th{background-color:#f6f6f6}table.plain tbody > tr:nth-child(odd) > td,table.plain tbody > tr:nth-child(odd) > th{background:transparent}iframe,amp-iframe,.fluid-width-video-wrapper{display:block;margin:1.75em 0}.fluid-width-video-wrapper iframe,.fluid-width-video-wrapper amp-iframe{margin:0}textarea,select,input{margin:0 0 5px 0;padding:6px 9px;width:260px;outline:0;border:#e7eef2 1px solid;background:#fff;border-radius:4px;box-shadow:none;font-family:"Open Sans", sans-serif;font-size:1.6rem;line-height:1.4em;font-weight:100;-webkit-appearance:none}textarea{min-width:250px;min-height:80px;max-width:340px;width:100%;height:auto}input[type="text"]:focus,input[type="email"]:focus,input[type="search"]:focus,input[type="tel"]:focus,input[type="url"]:focus,input[type="password"]:focus,input[type="number"]:focus,input[type="date"]:focus,input[type="month"]:focus,input[type="week"]:focus,input[type="time"]:focus,input[type="datetime"]:focus,input[type="datetime-local"]:focus,textarea:focus{outline:none;outline-width:0;border:#bbc7cc 1px solid;background:#fff}select{width:270px;height:30px;line-height:30px}.clearfix:before,.clearfix:after{content:" ";display:table}.clearfix:after{clear:both}.clearfix{zoom:1}.main-header{position:relative;display:table;overflow:hidden;box-sizing:border-box;width:100%;height:50px;background:#5ba4e5 no-repeat center center;background-size:cover;text-align:left;-webkit-box-sizing:border-box;-moz-box-sizing:border-box}.content{background:#fff;padding-top:15px}.blog-title,.content{margin:auto;max-width:600px}.blog-title a{display:block;padding-right:16px;padding-left:16px;height:50px;color:#fff;text-decoration:none;font-family:"Open Sans", sans-serif;font-size:16px;line-height:50px;font-weight:600}.post{position:relative;margin-top:0;margin-right:16px;margin-left:16px;padding-bottom:0;max-width:100%;border-bottom:#ebf2f6 1px solid;word-wrap:break-word;font-size:0.95em;line-height:1.65em}.post-header{margin-bottom:1rem}.post-title{margin-bottom:0}.post-title a{text-decoration:none}.post-meta{display:block;margin:3px 0 0 0;color:#9eabb3;font-family:"Open Sans", sans-serif;font-size:1.3rem;line-height:2.2rem}.post-meta a{color:#9eabb3;text-decoration:none}.post-meta a:hover{text-decoration:underline}.post-meta .author{margin:0;font-size:1.3rem;line-height:1.3em}.post-date{display:inline-block;text-transform:uppercase;white-space:nowrap;font-size:1.2rem;line-height:1.2em}.post-image{margin:0;padding-top:3rem;padding-bottom:30px;border-top:1px #E8E8E8 solid}.post-content amp-img,.post-content amp-anim{position:relative;left:50%;display:block;padding:0;min-width:0;max-width:112%;width:calc(100% + 32px);height:auto;transform:translateX(-50%);-webkit-transform:translateX(-50%);-ms-transform:translateX(-50%)}.footnotes{font-size:1.3rem;line-height:1.6em;font-style:italic}.footnotes li{margin:0.6rem 0}.footnotes p{margin:0}.footnotes p a:last-child{text-decoration:none}.site-footer{position:relative;margin:0 auto 20px auto;padding:1rem 15px;max-width:600px;color:rgba(0,0,0,0.5);font-family:"Open Sans", sans-serif;font-size:1.1rem;line-height:1.75em}.site-footer a{color:rgba(0,0,0,0.5);text-decoration:none;font-weight:bold}.site-footer a:hover{border-bottom:#bbc7cc 1px solid}.poweredby{display:block;float:right;width:45%;text-align:right}.copyright{display:block;float:left;width:45%}</style>

    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>

    <script async custom-element="amp-anim" src="https://cdn.ampproject.org/v0/amp-anim-0.1.js"></script>

</head>

<body class="amp-template">
    <header class="main-header">
        <nav class="blog-title">
            <a href="https://havedatawilltrain.com">HAVE DATA - WILL TRAIN</a>
        </nav>
    </header>

    <main class="content" role="main">
        <article class="post">

            <header class="post-header">
                <h1 class="post-title">The Service Room</h1>
                <section class="post-meta">
                    <p class="author">by <a href="/author/spyros/">Spyros Garyfallos</a></p>
                    <time class="post-date" datetime="2020-04-10">2020-04-10</time>
                </section>
            </header>
            <figure class="post-image">
                <amp-img src="https://havedatawilltrain.com/content/images/2020/04/willys-jeep-dashboard-marco-oliveira.jpg" width="600" height="400" layout="responsive"></amp-img>
            </figure>
            <section class="post-content">

                <p>Reading <strong>configuration settings </strong>is one of the most fundamental tasks of any IoT Edge application. We will postulate a configuration categorization and explore how this categorization maps to .NET. Although these examples are specific to Azure IoT Edge applications, the best practices presented here are generic and apply to all other application types.  </p><h2 id="application-configuration">Application Configuration</h2><h3></h3><p>A well-designed application needs to be able to adjust its behavior based on the <strong>environment </strong>it is running in. And although the definition of the environment can become a matter of debate, there are some commonly accepted standard environments in Software Engineering: <strong>Development</strong>, <strong>Test</strong>, <strong>Staging</strong> and <strong>Production</strong>. Apparently, some variability exists to the cardinality of these environments, sometimes merging together some of them (eg. Test and Staging), and similarly, an environment can split into more specialized cases.</p><p>In reality, besides the environments related to the application lifecycle, an environment can be defined arbitrarily: can be based on geographical location, on physical characteristics, like ambient temperature or water pH, business parameters, like if an item has been sold or not, etc. This diversity of all possible environments makes the environment modeling difficult.  </p><p>To shed some light, we'll draw an example from real life, something that almost all people can relate to, <strong>cars. </strong></p><blockquote>Cars can be one of the best analogy examples one can find, mostly because cars are complex machines that most people have interacted with. Cars carry many well-designed features that many software engineers draw inspiration from when designing things.</blockquote><h3 id="environments">Environments</h3><p>Most modern ECUs (the main computer of a car) are designed to behave differently when in maintenance mode, when the service mechanic plugs in the diagnostic tool. This can be seen as analogous to a Debugging environment, where the TCU architects made sure that the TCU will emit diagnostic information to help the mechanic understand if there are any issues with the car. These environments are called <strong>lifecycle environments</strong>. </p><p>A second category of an environment is the <strong>operating environment, </strong>the environment in which a car is driven in. Many SUVs allow the drivers to choose between 4x4 and rear wheel drive based on the operating environment traction requirements. Similarly, the vehicle A/C can be turned on and off, according to the environment conditions. You can either define explicitly the environment, via a push button, or infer the environment by reading the sensors; for example infer that it's currently raining by reading the rain sensor. Many of these environment-based decisions have been automated today: the vehicle lights will turn on when it's dark, the A/C will kick-in when it's hot etc. Nevertheless, the point here is that the vehicle designers made the car <strong>real-time configurable </strong>to conform to the operating environment conditions.</p><blockquote><u>If seen from this standpoint, <strong>the application configuration is effectively information that defines an environment!</strong></u></blockquote><h3 id="device-twin">Device Twin</h3><p>The long intro and the emphasis to the application configuration definition is necessary, because having a clear understanding of what the configuration information is and what is not, affects the abstraction decisions we make that down the line become the difference between a well-designed and a poorly-designed application. </p><p>The notion of a <strong>device twin </strong>exists in the IoT space.<strong> </strong>Specifically, in Azure IoT Edge, the <a href="https://docs.microsoft.com/en-us/azure/iot-hub/iot-hub-devguide-device-twins">definition</a> of the device twin is: "<em><u>Device twins</u></em><u> are JSON documents that store device state information including metadata, </u><strong><u>configurations</u></strong><u>, and conditions</u>". The device twin is practically a collection of name-value properties that fall into the two self-explanatory categories, the <strong>desired </strong>and the <strong>reported </strong>properties.</p><p>Let's go back to the car example. Congrats! You just got hired by an automotive company to write the TCU software of their new <strong>connected vehicle car model</strong>. Would you store any lifecycle environment information in the device twin? How about the operating environment information, like for example, if it's is currently raining?</p><p>The lines can get easily blurred between the device state, the device configuration conditions and metadata.  Using the car analogy, we can draw a clear line to separate the configuration in two major categories:</p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>System configuration</figcaption></figure><ul><li><strong>System (device) configuration</strong>, the configuration that the mechanic (administrator) can change, for example, set the engine idle RPM. The system configuration maps to the <strong>lifecycle environment definition. </strong>These environments are related to the lifecycle of the vehicle, are clearly defined and changing them usually requires an expert, tools and a vehicle restart.</li></ul><p></p><figure class="kg-card kg-image-card kg-card-hascaption"><figcaption>User configuration</figcaption></figure><ul><li><strong>User configuration</strong>, the configuration that the vehicle drivers (users) can change, for example, the steering wheel height or the radio station. This is easier to achieve through a user interface. The user configuration maps to the <strong>operation environment definition</strong>. This environment can change dynamically, no restart is required and the vehicle driver (user) has the power to define it.</li></ul><blockquote>Note: In IoT, there's always an administrator, and the devices that do not interact with users, don't have user configuration.</blockquote><p>By using these definitions, the rest of the story around configuration falls into place: </p><ol><li>The system configuration is kept into the system itself, and <strong>to change the system configuration, a restart is required, perhaps even a new deployment.</strong> The system configuration is enforced, the device either conforms, or fails to start. </li><li>On the other hand, the <strong>user configuration is persisted in the desired properties</strong> of the digital twin. These can change on the fly, and perhaps by external systems, and the device should try to do its best to honor these updates, although this configuration can be seen more like hints.</li><li>Finally, all the <strong>read-only sensory values are the reported properties</strong> of the device twin.</li></ol><blockquote>Food for thought: Where would you store the default values of the user configuration?</blockquote><p>Let's see now how all these look written in source code.</p><p>For system configuration we'll use the following  packages:</p><ul><li><code>Microsoft.Extensions.Configuration</code> </li><li><code>Microsoft.Extensions.Configuration.Abstractions</code></li><li><code>Microsoft.Extensions.Configuration.CommandLine</code></li><li><code>Microsoft.Extensions.Configuration.EnvironmentVariables</code></li><li><code>Microsoft.Extensions.Configuration.Json</code></li></ul><p>Using these packages we can write a simple application that reads the system information:</p><figure class="kg-card kg-code-card"><pre><code class="language-csharp">using System;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;

namespace Example5
{
    class Program
    {
        // This is the program entry point
        static async Task Main(string[] args)
        {
            // Read the system configuration
            IConfiguration configuration;
            configuration = new ConfigurationBuilder()
                .AddJsonFile("appsettings.json", optional: true)
                .AddEnvironmentVariables()
                .AddCommandLine(args)
                .Build();

            if (configuration["Environment"] == "Debug")
            {
                Console.WriteLine($"Configuring for debugging environment..");
                // Code omitted
            }
            Console.WriteLine("Exiting..");
        }
    }
}</code></pre><figcaption>Reading the System Configuration using <code>Microsoft.Extensions.Configuration</code></figcaption></figure><p>The <code>IConfiguration</code> property will hold the configuration settings <strong>union</strong>, based on the order of composition we define. In this example, we start with an optional local JSON file <code>appsettings.json</code>, then we add the environment variables and the command line arguments. Each time we add a new configuration source, we override any variables with the same name.</p><blockquote>A good practice is to keep the hosting environment configuration last. This allows us change the configuration without redeploying a new file system version.</blockquote><p>Running this application with command line arguments makes easier to test our code:</p><figure class="kg-card kg-image-card"></figure><p>To read the user configuration from the device twin, we can use this code snippet:</p><figure class="kg-card kg-code-card"><pre><code class="language-csharp">await ModuleClient.OpenAsync();
var twin = await ModuleClient.GetTwinAsync();
if (twin!= null &amp;&amp; twin.Properties.Desired.Contains("IntervalInSeconds"))
	int.TryParse(twin.Properties.Desired["IntervalInSeconds"], out IntervalInSeconds);</code></pre><figcaption>Reading user configuration from the device twin </figcaption></figure><p>Revisiting the original thermostat example we saw in the <a href="https://havedatawilltrain.com/the-waiting-loop/">previous post</a>, now thermostat code looks like:</p><pre><code class="language-csharp">using System;
using System.Runtime.Loader;
using System.Threading;
using System.Threading.Tasks;
using Microsoft.Extensions.Configuration;

namespace Example6
{
    class Program
    {
        // This is the program entry point
        static async Task Main(string[] args)
        {
            // Read the system configuration
            IConfiguration configuration;
            configuration = new ConfigurationBuilder()
                .AddJsonFile("appsettings.json", optional: true)
                .AddEnvironmentVariables()
                .AddCommandLine(args)
                .Build();

            // Create the cancelation token source
            var cancellationTokenSource = new CancellationTokenSource();
            AssemblyLoadContext.Default.Unloading +=
                (cts) =&gt; cancellationTokenSource.Cancel();

            Console.CancelKeyPress +=
                (sender, cts) =&gt;
                {
                    Console.WriteLine("Ctrl+C detected.");
                    cts.Cancel = true;
                    cancellationTokenSource.Cancel();
                };

            // Register the Reset command callback 
            await RegisterCommandCallbackAsync("Reset",
                OnReset,
                cancellationTokenSource.Token);

            // Read the system configuration or default to 1
            int interval;
            if (!int.TryParse(
                configuration["IntervalInSeconds"],
                out interval))
                interval = 1;

            // Create and start the TaskTimer
            TaskTimer taskTimer = new TaskTimer(
                EmitTelemetryMessage,
                TimeSpan.FromSeconds(interval), 
                cancellationTokenSource);

            // A non-blocking call to start the task-timer
            taskTimer.Start();

            // Wait until the app unloads or gets cancelled
            await WhenCancelled(cancellationTokenSource.Token);

            // Let the other threads drain
            Console.WriteLine("Waiting for 2 seconds..");
            await Task.Delay(2 * 1000);

            Console.WriteLine("Exiting..");
        }

        public static Task WhenCancelled(CancellationToken cancellationToken)
        {
            var taskCompletionSource = new TaskCompletionSource&lt;bool&gt;();
            cancellationToken.Register(
                s =&gt; ((TaskCompletionSource&lt;bool&gt;)s).SetResult(true),
                taskCompletionSource);
            return taskCompletionSource.Task;
        }
        private static async Task RegisterCommandCallbackAsync(string command,
            Action callback,
            CancellationToken cancellationToken)
        {
            // Perform the command registration
            // Code omitted
            return;
        }

        // A method exposed for RPC
        static void OnReset()
        {
            // Perform a temperature sensor reset
            // Code omitted
        }

        // Emit telemetry message
        static void EmitTelemetryMessage()
        {
            Console.WriteLine($"Sending telemetry message..");
        }
    }
}
</code></pre><blockquote>So far in this mini-series we have deliberately avoided using the Azure IoT SDK, the idea being, we want to build a <strong>hosting environment agnostic </strong>application, were the code is not coupled to a specific hosting technology. With this approach, hosting it on the Edge becomes a choice, and helps us to develop most of the code in our preferred development environment.</blockquote><p>As alluded to this post, one of the most popular cases for reconfiguring the IoT application is for debugging purposes. In the next post we will explore the best practices on application logging.</p>

            </section>

        </article>
    </main>
    <footer class="site-footer clearfix">
        <section class="copyright"><a href="https://havedatawilltrain.com">HAVE DATA - WILL TRAIN</a> &copy; 2020</section>
        <section class="poweredby">Proudly published with <a href="https://ghost.org">Ghost</a></section>
    </footer>
</body>
</html>
